<html>
<head>
	<title>The Night Watch Level Editor</title>
	<meta charset="UTF-8">
	<script src="https://d3js.org/d3.v5.min.js"></script>
	<script src="https://d3js.org/d3-drag.v1.min.js"></script>
	<link href="https://fonts.googleapis.com/css?family=Inconsolata&display=swap" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Montserrat:200,200i&display=swap" rel="stylesheet">
</head>
<body bgcolor="#f8f8f8" style="text-align: center;">
	<h3 style="font-family: Montserrat;">Welcome to Version 0.0.0.0.1 ðŸ‘€</h3>
	<svg height="800" width="800" class="mainGrid"/>
	<script>

		let svgHeight = 800;
		let svgWidth = 800;
		let numGridWidth = 24;
		let numGridHeight = 18;
		let tileSize = 30;
		let selectedToggle = "";
		let grid = [];
		let isClickDisabled = true;

		let wallColor = "#A7333F";
		let doorColor = "#FFB959";
		let thiefColor = "#82AAB5";
		let whiteColor = "#ffffff";
		let greyColor = "#cdcdcd";

		let isNewThief = false;
		let tempThievesList = [];


		let toggleColor = {"wall": wallColor, "door": doorColor, "thief": thiefColor};


		function createToggleButton() {
			var keys = ["wall", "door", "thief"];
			var buttonSize = 100;
			var spaceBetweenButtons = 30;
			var startingX = (svgHeight-100*keys.length-30*(keys.length-1))/2;

			var gridSvg = d3.select(".mainGrid");

			gridSvg.selectAll(".toggle")
	   			.data(keys)
	   			.enter()
	   			.append("rect")
				.attr("class", "toggle")
				.attr("id", function(d) {return "toggle_"+d})
				.attr("x", function(d, i) {
					return startingX+130*i;
				}).attr("y", 50)
				.attr("width", 100)
				.attr("height", 50)
				.style("stroke", "black")
				.style("fill", whiteColor)
				.on("click", function(d, i) {
					selectedToggle = d;

					d3.selectAll(".toggle")
						.transition()
						.duration(50)
						.style("fill", whiteColor);
					d3.select("#toggle_"+d)
						.transition()
						.duration(100)
						.style("fill", toggleColor[d]);

					isClickDisabled = false;

				});


			for (var i = 0; i < keys.length; i++) {
				gridSvg.append("text")
					.attr("x", (startingX+130*i)+50)
					.attr("y", 80)
					.style("text-anchor", "middle")
					.style("font-family", "Inconsolata")
					.style("font-color", "black")
					.text(keys[i]);
			}

			gridSvg.append("rect")
				.attr("x", 10)
				.attr("y", 50)
				.attr("width", 100)
				.attr("height", 50)
				.style("stroke", "black")
				.style("fill", whiteColor)
				.on("click", function() {
					d3.selectAll(".cell").style("fill", whiteColor);
					isClickDisabled = false;
					selectedToggle = "";
					d3.selectAll(".toggle")
						.transition()
						.duration(50)
						.style("fill", whiteColor);
				});

			gridSvg.append("text")
				.attr("x", 60)
				.attr("y", 80)
				.style("text-anchor", "middle")
				.style("font-family", "Inconsolata")
				.style("font-color", "black")
				.text("reset");

			gridSvg.append("rect")
				.attr("x", 690)
				.attr("y", 50)
				.attr("width", 100)
				.attr("height", 50)
				.style("stroke", "black")
				.style("fill", whiteColor)
				.on("click", function() {
					exportFile(createFinalJson());
					isNewThief = false;
					isClickDisabled = true;
					selectedToggle = "";
				});

			gridSvg.append("text")
				.attr("x", 740)
				.attr("y", 80)
				.style("text-anchor", "middle")
				.style("font-family", "Inconsolata")
				.style("font-color", "black")
				.text("export");
		}


		function createGridDS() {
			for (var i = 0; i < numGridWidth; i++) {
				for (var j = 0; j < numGridHeight; j++) {
					grid.push({"x": i, "y": j});
				}
			}
		}

		function drawGrid() {
			var gridSvg = d3.select(".mainGrid");

			gridSvg.on("click", function() {
				isClickDisabled = !isClickDisabled;

				if (!isClickDisabled && selectedToggle == "thief") {
					isNewThief = true;
				}
			})

			var startingX = (svgWidth - numGridWidth*tileSize)/2;

			console.log(grid);
			gridSvg.selectAll(".cell").data(grid).enter()
				.append("rect")
				.attr("class", "cell")
				.attr("id", function(d) {return "cell_"+d.x+"_"+d.y})
				.attr("x", function(d) {return startingX+tileSize*Number(d.x)})
				.attr("y", function(d) {return 150+tileSize*Number(d.y)})
				.attr("width", tileSize)
				.attr("height", tileSize)
				.style("fill", whiteColor)
				.style("stroke", greyColor)
				.style("stroke-width", 2)
				.on("mousemove", function(d) {
					if (!isClickDisabled && selectedToggle != "") {
						var element = d3.select("#cell_"+d.x+"_"+d.y);

						// if the square are white, add to grid
						if (element.style("fill") == "rgb(255, 255, 255)") {
							element.style("fill", toggleColor[selectedToggle]);
						}

						// adding thief's starting point
						if (isNewThief && selectedToggle == "thief") {
							tempThievesList.push({"x": d.x, "y": numGridHeight-d.y});
							isNewThief = false;
						}
					}
				});

		}

		function dragstarted(d) {
			console.log(d);
			var element = d3.select("#cell_"+d.x+"_"+d.y);
		    d3.select(element).style("fill", wallColor);
		}


	  	function dragged(d) {
	    	// d3.select(this).attr("cx", d.x = d3.event.x).attr("cy", d.y = d3.event.y);
	    	d3.select(d).attr("fill", wallColor);
	    	console.log(d.x + " " + d.y);
	  	}

	  	function createFinalJson() {
	  		console.log(tempThievesList);
	  		var defaultJson = {
	  			"version": "0.1",
	  			"walls": [],
	  			"thieves": tempThievesList,
	  			"width": numGridWidth,
	  			"height": numGridHeight, 
	  			"numGuards": 3
	  		};

	  		// getting wall and door values 
	  		for (var i = 0; i < numGridWidth; i++) {
	  			for (var j = 0; j < numGridHeight; j++) {
	  				var element = d3.select("#cell_"+i+"_"+j);
	  				console.log(element.style("fill"));

	  				// walls
	  				if (element.style("fill") == "rgb(167, 51, 63)") {
	  					defaultJson["walls"].push({"x": i, "y": numGridHeight-j});
	  				} 

	  			}
	  		}
	  		console.log(defaultJson);
	  		return defaultJson;
	  	}

	  	function exportFile(defaultJson) {
	  		var pp = document.createElement('a');
                pp.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(JSON.stringify(defaultJson)));
                pp.setAttribute('download', "thenightwatch.json");
                pp.click();
	  	}

	  	createGridDS();
		createToggleButton();
		drawGrid();
		
	</script>
</body>
</html>